{% extends "base.html" %}

{% block title %}Create Certificate - qPKI{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-file-contract me-2 text-primary"></i>Create Certificate
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('list_certs') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list me-1"></i>View Certificates
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header quantum-gradient text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>New Certificate
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- Certificate Authority Selection -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-certificate me-2"></i>Certificate Authority
                        </h6>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="ca_filename" class="form-label">Signing CA *</label>
                                <select class="form-select" id="ca_filename" name="ca_filename" required>
                                    <option value="">Select Certificate Authority...</option>
                                    {% for ca in cas %}
                                        <option value="{{ ca.filename }}">{{ ca.common_name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Choose the CA that will sign this certificate</div>
                            </div>
                        </div>

                        <!-- Certificate Subject Information -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-id-card me-2"></i>Certificate Subject Information
                        </h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="common_name" class="form-label">Common Name (CN) *</label>
                                <input type="text" class="form-control" id="common_name" name="common_name" required
                                       placeholder="e.g., www.example.com or John Doe">
                                <div class="form-text">Domain name for server certs, or person name for client certs</div>
                            </div>
                            <div class="col-md-6">
                                <label for="organization" class="form-label">Organization (O)</label>
                                <input type="text" class="form-control" id="organization" name="organization"
                                       placeholder="e.g., MyCompany Inc">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="organizational_unit" class="form-label">Organizational Unit (OU)</label>
                                <input type="text" class="form-control" id="organizational_unit" name="organizational_unit"
                                       placeholder="e.g., IT Department">
                            </div>
                            <div class="col-md-6">
                                <label for="country" class="form-label">Country (C)</label>
                                <input type="text" class="form-control" id="country" name="country" 
                                       maxlength="2" minlength="2"
                                       placeholder="e.g., US" style="text-transform: uppercase;">
                                <div class="form-text">2-letter country code</div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="state" class="form-label">State/Province</label>
                                <input type="text" class="form-control" id="state" name="state"
                                       placeholder="e.g., California">
                            </div>
                            <div class="col-md-4">
                                <label for="locality" class="form-label">Locality/City</label>
                                <input type="text" class="form-control" id="locality" name="locality"
                                       placeholder="e.g., San Francisco">
                            </div>
                            <div class="col-md-4">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" name="email" required
                                       placeholder="e.g., user@example.com">
                                <div class="form-text">Required for expiration notifications</div>
                            </div>
                        </div>

                        <!-- Certificate Type Selection -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-key me-2"></i>Certificate Type
                        </h6>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="cert_type" id="cert_type_hybrid" value="hybrid" checked>
                                    <label class="form-check-label" for="cert_type_hybrid">
                                        <i class="fas fa-shield-alt text-success me-1"></i><strong>Hybrid (Quantum-Safe)</strong>
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="cert_type" id="cert_type_pqc" value="pqc">
                                    <label class="form-check-label" for="cert_type_pqc">
                                        <i class="fas fa-atom text-warning me-1"></i><strong>PQC (ML-DSA only)</strong>
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="cert_type" id="cert_type_classic" value="classic">
                                    <label class="form-check-label" for="cert_type_classic">
                                        <i class="fas fa-lock text-primary me-1"></i><strong>Classic (RSA/ECC only)</strong>
                                    </label>
                                </div>
                                <div class="form-text mt-2">
                                    <strong>Hybrid:</strong> Uses both classic and post-quantum algorithms for future security<br>
                                    <strong>PQC:</strong> Uses only post-quantum ML-DSA (Dilithium) algorithm for quantum resistance<br>
                                    <strong>Classic:</strong> Uses only traditional RSA or ECC algorithms for compatibility
                                </div>
                            </div>
                        </div>

                        <!-- Classic Certificate Algorithm Selection (Hidden by default) -->
                        <div id="classic_algorithm_section" class="row mb-4" style="display: none;">
                            <div class="col-md-4">
                                <label for="classic_algorithm" class="form-label">Algorithm *</label>
                                <select class="form-select" id="classic_algorithm" name="classic_algorithm">
                                    <option value="RSA">RSA</option>
                                    <option value="ECC">ECC (Elliptic Curve)</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="rsa_key_size_section">
                                <label for="classic_rsa_key_size" class="form-label">RSA Key Size</label>
                                <select class="form-select" id="classic_rsa_key_size" name="classic_rsa_key_size">
                                    <option value="2048">2048 bits</option>
                                    <option value="3072">3072 bits</option>
                                    <option value="4096">4096 bits</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="ecc_curve_section" style="display: none;">
                                <label for="classic_ecc_curve" class="form-label">ECC Curve</label>
                                <select class="form-select" id="classic_ecc_curve" name="classic_ecc_curve">
                                    <option value="secp256r1">P-256 (secp256r1)</option>
                                    <option value="secp384r1">P-384 (secp384r1)</option>
                                    <option value="secp521r1">P-521 (secp521r1)</option>
                                </select>
                            </div>
                        </div>

                        <!-- PQC Certificate Algorithm Selection (Hidden by default) -->
                        <div id="pqc_algorithm_section" class="row mb-4" style="display: none;">
                            <div class="col-md-6">
                                <label for="pqc_dilithium_variant" class="form-label">ML-DSA (Dilithium) Variant *</label>
                                <select class="form-select" id="pqc_dilithium_variant" name="pqc_dilithium_variant">
                                    <option value="2">ML-DSA-44 (Dilithium2) - Fastest</option>
                                    <option value="3" selected>ML-DSA-65 (Dilithium3) - Balanced</option>
                                    <option value="5">ML-DSA-87 (Dilithium5) - Highest Security</option>
                                </select>
                                <div class="form-text">Choose the security level for the post-quantum signature algorithm</div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Pure PQC Certificate:</strong><br>
                                    <small>This certificate will use only post-quantum cryptography (ML-DSA/Dilithium). 
                                    It may not be compatible with legacy systems that don't support post-quantum algorithms.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Key Usage Selection -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-key me-2"></i>Key Usage
                        </h6>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <p class="mb-3 text-muted">Select the allowed uses for this certificate's key:</p>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="digital_signature" name="key_usage" value="digital_signature" checked>
                                            <label class="form-check-label" for="digital_signature">
                                                <strong>Digital Signature</strong>
                                                <br><small class="text-muted">Used to verify digital signatures on objects other than public keys and attribute certificates</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="key_encipherment" name="key_usage" value="key_encipherment">
                                            <label class="form-check-label" for="key_encipherment">
                                                <strong>Key Encipherment</strong>
                                                <br><small class="text-muted">Used to encrypt/decrypt symmetric keys for key transport</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="data_encipherment" name="key_usage" value="data_encipherment">
                                            <label class="form-check-label" for="data_encipherment">
                                                <strong>Data Encipherment</strong>
                                                <br><small class="text-muted">Used to encrypt/decrypt user data directly</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="key_agreement" name="key_usage" value="key_agreement">
                                            <label class="form-check-label" for="key_agreement">
                                                <strong>Key Agreement</strong>
                                                <br><small class="text-muted">Used with a key agreement protocol to establish a key</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="non_repudiation" name="key_usage" value="non_repudiation">
                                            <label class="form-check-label" for="non_repudiation">
                                                <strong>Non-Repudiation</strong>
                                                <br><small class="text-muted">Used to verify digital signatures for non-repudiation</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="key_cert_sign" name="key_usage" value="key_cert_sign">
                                            <label class="form-check-label" for="key_cert_sign">
                                                <strong>Certificate Signing</strong>
                                                <br><small class="text-muted">Used to verify signatures on public key certificates</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="crl_sign" name="key_usage" value="crl_sign">
                                            <label class="form-check-label" for="crl_sign">
                                                <strong>CRL Signing</strong>
                                                <br><small class="text-muted">Used to verify signatures on certificate revocation lists</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="encipher_only" name="key_usage" value="encipher_only">
                                            <label class="form-check-label" for="encipher_only">
                                                <strong>Encipher Only</strong>
                                                <br><small class="text-muted">Only for enciphering data during key agreement</small>
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="decipher_only" name="key_usage" value="decipher_only">
                                            <label class="form-check-label" for="decipher_only">
                                                <strong>Decipher Only</strong>
                                                <br><small class="text-muted">Only for deciphering data during key agreement</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Predefined Key Usage Templates -->
                                <div class="mt-3">
                                    <h6 class="text-muted mb-2">Quick Templates:</h6>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setKeyUsageTemplate('server')">
                                            <i class="fas fa-server me-1"></i>Server Certificate
                                        </button>
                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="setKeyUsageTemplate('client')">
                                            <i class="fas fa-user me-1"></i>Client Certificate
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="setKeyUsageTemplate('ca')">
                                            <i class="fas fa-certificate me-1"></i>CA Certificate
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setKeyUsageTemplate('clear')">
                                            <i class="fas fa-times me-1"></i>Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Certificate Parameters -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cog me-2"></i>Certificate Parameters
                        </h6>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="validity_days" class="form-label">Validity Period *</label>
                                <select class="form-select" id="validity_days" name="validity_days" required>
                                    <option value="30">30 days (Testing)</option>
                                    <option value="90">90 days (Short-term)</option>
                                    <option value="365" selected>1 year (Standard)</option>
                                    <option value="730">2 years (Extended)</option>
                                    <option value="1095">3 years (Long-term)</option>
                                </select>
                                <div class="form-text">How long this certificate should be valid</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Certificate
                            </button>
                            <a href="{{ url_for('list_certs') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Information Panel -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Certificate Information
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        This certificate will be signed by the selected CA and inherit its 
                        cryptographic algorithms and security properties.
                    </p>
                    
                    <h6><i class="fas fa-shield-alt text-primary me-2"></i>Security Features</h6>
                    <ul class="list-unstyled ms-3">
                        <li><i class="fas fa-check text-success me-2"></i>Hybrid signatures</li>
                        <li><i class="fas fa-check text-success me-2"></i>CA-signed validity</li>
                        <li><i class="fas fa-check text-success me-2"></i>Quantum-resistant</li>
                    </ul>

                    <h6 class="mt-3"><i class="fas fa-lightbulb text-warning me-2"></i>Tips</h6>
                    <ul class="list-unstyled ms-3">
                        <li class="mb-2">
                            <small>
                                <i class="fas fa-info-circle text-info me-1"></i>
                                Use domain names (e.g., www.example.com) for server certificates
                            </small>
                        </li>
                        <li class="mb-2">
                            <small>
                                <i class="fas fa-info-circle text-info me-1"></i>
                                Use person names (e.g., John Doe) for client certificates
                            </small>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> The certificate will use the same cryptographic algorithms 
                as the selected Certificate Authority.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-uppercase country code
    document.getElementById('country').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });

    // Handle certificate type selection
    function updateCertificateTypeUI() {
        const isHybrid = document.getElementById('cert_type_hybrid').checked;
        const isPQC = document.getElementById('cert_type_pqc').checked;
        const isClassic = document.getElementById('cert_type_classic').checked;
        
        const classicSection = document.getElementById('classic_algorithm_section');
        const pqcSection = document.getElementById('pqc_algorithm_section');
        const infoPanel = document.querySelector('.alert-info');
        const securityFeatures = document.querySelector('.card-body ul');
        
        // Hide all algorithm sections first
        classicSection.style.display = 'none';
        pqcSection.style.display = 'none';
        
        if (isHybrid) {
            infoPanel.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> The certificate will use the same cryptographic algorithms 
                as the selected Certificate Authority (hybrid quantum-safe).
            `;
            securityFeatures.innerHTML = `
                <li><i class="fas fa-check text-success me-2"></i>Hybrid signatures</li>
                <li><i class="fas fa-check text-success me-2"></i>CA-signed validity</li>
                <li><i class="fas fa-check text-success me-2"></i>Quantum-resistant</li>
            `;
        } else if (isPQC) {
            pqcSection.style.display = 'flex';
            infoPanel.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> Pure PQC certificate uses only post-quantum ML-DSA (Dilithium) 
                signatures for maximum quantum resistance.
            `;
            securityFeatures.innerHTML = `
                <li><i class="fas fa-check text-warning me-2"></i>Pure post-quantum</li>
                <li><i class="fas fa-check text-success me-2"></i>CA-signed validity</li>
                <li><i class="fas fa-check text-success me-2"></i>Future-proof security</li>
            `;
        } else if (isClassic) {
            classicSection.style.display = 'flex';
            infoPanel.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> Classic certificate uses only traditional cryptography 
                (RSA or ECC) for maximum compatibility.
            `;
            securityFeatures.innerHTML = `
                <li><i class="fas fa-check text-primary me-2"></i>Traditional algorithms</li>
                <li><i class="fas fa-check text-success me-2"></i>CA-signed validity</li>
                <li><i class="fas fa-check text-warning me-2"></i>Legacy compatibility</li>
            `;
            
            updateClassicAlgorithmUI();
        }
    }

    // Handle classic algorithm selection
    function updateClassicAlgorithmUI() {
        const algorithm = document.getElementById('classic_algorithm').value;
        const rsaSection = document.getElementById('rsa_key_size_section');
        const eccSection = document.getElementById('ecc_curve_section');
        
        if (algorithm === 'RSA') {
            rsaSection.style.display = 'block';
            eccSection.style.display = 'none';
        } else {
            rsaSection.style.display = 'none';
            eccSection.style.display = 'block';
        }
    }

    // Event listeners
    document.getElementById('cert_type_hybrid').addEventListener('change', updateCertificateTypeUI);
    document.getElementById('cert_type_pqc').addEventListener('change', updateCertificateTypeUI);
    document.getElementById('cert_type_classic').addEventListener('change', updateCertificateTypeUI);
    document.getElementById('classic_algorithm').addEventListener('change', updateClassicAlgorithmUI);

    // Key Usage Templates
    function setKeyUsageTemplate(template) {
        // Get all key usage checkboxes
        const checkboxes = document.querySelectorAll('input[name="key_usage"]');
        
        // Clear all checkboxes first
        checkboxes.forEach(cb => cb.checked = false);
        
        // Apply template-specific selections
        switch(template) {
            case 'server':
                // Server certificates typically need digital signature and key encipherment
                document.getElementById('digital_signature').checked = true;
                document.getElementById('key_encipherment').checked = true;
                break;
            case 'client':
                // Client certificates typically need digital signature and non-repudiation
                document.getElementById('digital_signature').checked = true;
                document.getElementById('non_repudiation').checked = true;
                break;
            case 'ca':
                // CA certificates need certificate signing and CRL signing
                document.getElementById('digital_signature').checked = true;
                document.getElementById('key_cert_sign').checked = true;
                document.getElementById('crl_sign').checked = true;
                break;
            case 'clear':
                // Already cleared above, do nothing
                break;
        }
    }

    // Initialize UI
    updateCertificateTypeUI();
</script>
{% endblock %}
