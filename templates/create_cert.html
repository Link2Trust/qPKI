{% extends "base.html" %}

{% block title %}Create Certificate - qPKI{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-file-contract me-2 text-primary"></i>Create Certificate
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('list_certs') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list me-1"></i>View Certificates
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header quantum-gradient text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>New Certificate
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- Certificate Authority Selection -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-certificate me-2"></i>Certificate Authority
                        </h6>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="ca_filename" class="form-label">Signing CA *</label>
                                <select class="form-select" id="ca_filename" name="ca_filename" required>
                                    <option value="">Select Certificate Authority...</option>
                                    {% for ca in cas %}
                                        <option value="{{ ca.filename }}">{{ ca.common_name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Choose the CA that will sign this certificate</div>
                            </div>
                        </div>

                        <!-- Certificate Subject Information -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-id-card me-2"></i>Certificate Subject Information
                        </h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="common_name" class="form-label">Common Name (CN) *</label>
                                <input type="text" class="form-control" id="common_name" name="common_name" required
                                       placeholder="e.g., www.example.com or John Doe">
                                <div class="form-text">Domain name for server certs, or person name for client certs</div>
                            </div>
                            <div class="col-md-6">
                                <label for="organization" class="form-label">Organization (O)</label>
                                <input type="text" class="form-control" id="organization" name="organization"
                                       placeholder="e.g., MyCompany Inc">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="organizational_unit" class="form-label">Organizational Unit (OU)</label>
                                <input type="text" class="form-control" id="organizational_unit" name="organizational_unit"
                                       placeholder="e.g., IT Department">
                            </div>
                            <div class="col-md-6">
                                <label for="country" class="form-label">Country (C)</label>
                                <input type="text" class="form-control" id="country" name="country" 
                                       maxlength="2" minlength="2"
                                       placeholder="e.g., US" style="text-transform: uppercase;">
                                <div class="form-text">2-letter country code</div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="state" class="form-label">State/Province</label>
                                <input type="text" class="form-control" id="state" name="state"
                                       placeholder="e.g., California">
                            </div>
                            <div class="col-md-4">
                                <label for="locality" class="form-label">Locality/City</label>
                                <input type="text" class="form-control" id="locality" name="locality"
                                       placeholder="e.g., San Francisco">
                            </div>
                            <div class="col-md-4">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" name="email" required
                                       placeholder="e.g., user@example.com">
                                <div class="form-text">Required for expiration notifications</div>
                            </div>
                        </div>

                        <!-- Certificate Type Selection -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-key me-2"></i>Certificate Type
                        </h6>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="cert_type" id="cert_type_hybrid" value="hybrid" checked>
                                    <label class="form-check-label" for="cert_type_hybrid">
                                        <i class="fas fa-shield-alt text-success me-1"></i><strong>Hybrid (Quantum-Safe)</strong>
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="cert_type" id="cert_type_classic" value="classic">
                                    <label class="form-check-label" for="cert_type_classic">
                                        <i class="fas fa-lock text-primary me-1"></i><strong>Classic (RSA/ECC only)</strong>
                                    </label>
                                </div>
                                <div class="form-text mt-2">
                                    <strong>Hybrid:</strong> Uses both classic and post-quantum algorithms for future security<br>
                                    <strong>Classic:</strong> Uses only traditional RSA or ECC algorithms for compatibility
                                </div>
                            </div>
                        </div>

                        <!-- Classic Certificate Algorithm Selection (Hidden by default) -->
                        <div id="classic_algorithm_section" class="row mb-4" style="display: none;">
                            <div class="col-md-4">
                                <label for="classic_algorithm" class="form-label">Algorithm *</label>
                                <select class="form-select" id="classic_algorithm" name="classic_algorithm">
                                    <option value="RSA">RSA</option>
                                    <option value="ECC">ECC (Elliptic Curve)</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="rsa_key_size_section">
                                <label for="classic_rsa_key_size" class="form-label">RSA Key Size</label>
                                <select class="form-select" id="classic_rsa_key_size" name="classic_rsa_key_size">
                                    <option value="2048">2048 bits</option>
                                    <option value="3072">3072 bits</option>
                                    <option value="4096">4096 bits</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="ecc_curve_section" style="display: none;">
                                <label for="classic_ecc_curve" class="form-label">ECC Curve</label>
                                <select class="form-select" id="classic_ecc_curve" name="classic_ecc_curve">
                                    <option value="secp256r1">P-256 (secp256r1)</option>
                                    <option value="secp384r1">P-384 (secp384r1)</option>
                                    <option value="secp521r1">P-521 (secp521r1)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Certificate Parameters -->
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cog me-2"></i>Certificate Parameters
                        </h6>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="validity_days" class="form-label">Validity Period *</label>
                                <select class="form-select" id="validity_days" name="validity_days" required>
                                    <option value="30">30 days (Testing)</option>
                                    <option value="90">90 days (Short-term)</option>
                                    <option value="365" selected>1 year (Standard)</option>
                                    <option value="730">2 years (Extended)</option>
                                    <option value="1095">3 years (Long-term)</option>
                                </select>
                                <div class="form-text">How long this certificate should be valid</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Certificate
                            </button>
                            <a href="{{ url_for('list_certs') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Information Panel -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Certificate Information
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        This certificate will be signed by the selected CA and inherit its 
                        cryptographic algorithms and security properties.
                    </p>
                    
                    <h6><i class="fas fa-shield-alt text-primary me-2"></i>Security Features</h6>
                    <ul class="list-unstyled ms-3">
                        <li><i class="fas fa-check text-success me-2"></i>Hybrid signatures</li>
                        <li><i class="fas fa-check text-success me-2"></i>CA-signed validity</li>
                        <li><i class="fas fa-check text-success me-2"></i>Quantum-resistant</li>
                    </ul>

                    <h6 class="mt-3"><i class="fas fa-lightbulb text-warning me-2"></i>Tips</h6>
                    <ul class="list-unstyled ms-3">
                        <li class="mb-2">
                            <small>
                                <i class="fas fa-info-circle text-info me-1"></i>
                                Use domain names (e.g., www.example.com) for server certificates
                            </small>
                        </li>
                        <li class="mb-2">
                            <small>
                                <i class="fas fa-info-circle text-info me-1"></i>
                                Use person names (e.g., John Doe) for client certificates
                            </small>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> The certificate will use the same cryptographic algorithms 
                as the selected Certificate Authority.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-uppercase country code
    document.getElementById('country').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });

    // Handle certificate type selection
    function updateCertificateTypeUI() {
        const isHybrid = document.getElementById('cert_type_hybrid').checked;
        const classicSection = document.getElementById('classic_algorithm_section');
        const infoPanel = document.querySelector('.alert-info');
        const securityFeatures = document.querySelector('.card-body ul');
        
        if (isHybrid) {
            classicSection.style.display = 'none';
            infoPanel.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> The certificate will use the same cryptographic algorithms 
                as the selected Certificate Authority (hybrid quantum-safe).
            `;
            securityFeatures.innerHTML = `
                <li><i class="fas fa-check text-success me-2"></i>Hybrid signatures</li>
                <li><i class="fas fa-check text-success me-2"></i>CA-signed validity</li>
                <li><i class="fas fa-check text-success me-2"></i>Quantum-resistant</li>
            `;
        } else {
            classicSection.style.display = 'flex';
            infoPanel.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Note:</strong> Classic certificate uses only traditional cryptography 
                (RSA or ECC) for maximum compatibility.
            `;
            securityFeatures.innerHTML = `
                <li><i class="fas fa-check text-primary me-2"></i>Traditional algorithms</li>
                <li><i class="fas fa-check text-success me-2"></i>CA-signed validity</li>
                <li><i class="fas fa-check text-warning me-2"></i>Legacy compatibility</li>
            `;
        }
        
        updateClassicAlgorithmUI();
    }

    // Handle classic algorithm selection
    function updateClassicAlgorithmUI() {
        const algorithm = document.getElementById('classic_algorithm').value;
        const rsaSection = document.getElementById('rsa_key_size_section');
        const eccSection = document.getElementById('ecc_curve_section');
        
        if (algorithm === 'RSA') {
            rsaSection.style.display = 'block';
            eccSection.style.display = 'none';
        } else {
            rsaSection.style.display = 'none';
            eccSection.style.display = 'block';
        }
    }

    // Event listeners
    document.getElementById('cert_type_hybrid').addEventListener('change', updateCertificateTypeUI);
    document.getElementById('cert_type_classic').addEventListener('change', updateCertificateTypeUI);
    document.getElementById('classic_algorithm').addEventListener('change', updateClassicAlgorithmUI);

    // Initialize UI
    updateCertificateTypeUI();
</script>
{% endblock %}
